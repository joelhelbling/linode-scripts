#!/bin/bash

if [ "$1" == "" ]; then
  echo "You must provide the name of a linode you wish to rebuild"
  exit 1
fi

generate_password() {
  echo "`openssl rand -base64 16 | tr -dc a-zA-Z0-9 | tr 'AEIOU' 'aeiou' | tr '0-4' '.' | tr '5-9' '-'`"
}

LABEL=$1
DISTRIBUTION="Ubuntu 16.04 LTS"
STACKSCRIPT_NAME="hbj_initial_setup"

STACKSCRIPT_ID=`linode stackscript show $STACKSCRIPT_NAME | grep id: | awk '/\s*/ {print $2}'`
ROOT_PASSWORD=`generate_password`
USER_PASSWORD=`generate_password`
JSON=`jq -c "setpath([\"PASSWORD\"]; \"$USER_PASSWORD\")" udf.json`

echo running with json: $JSON

if [ -z "$DRY_RUN" ]; then
  linode rebuild \
    --label "$LABEL" \
    --distribution "$DISTRIBUTION" \
    --password "$ROOT_PASSWORD" \
    --stackscript "$STACKSCRIPT_ID" \
    --stackscriptjson $JSON
fi

cat <<EOF
Root password: $ROOT_PASSWORD
User password: $USER_PASSWORD
EOF
